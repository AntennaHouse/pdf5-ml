<?xml version="1.0" encoding="UTF-8"?>
<project>
  <property name="pdf5.ml.plugin.folder" value="com.antennahouse.pdf5.ml"/>
  <property name="pdf5.ml.dir" value="plugins"/>

  <taskdef name="version.comp" classname="com.antennahouse.ant_utils.VersionComp"/>

  <!-- preprocess selection -->
  <property name="adopt.preprocess2" value="no"/>

  <!--propeties in the preprocess -->
  <basename property="dita.input.filename" file="${args.input}"/>
  <pathconvert property="dita.map.filename.root">
    <path path="${dita.input.filename}"/>
    <chainedmapper>
      <mapper type="flatten"/>
      <mapper type="regexp" from="^(.+)(\..+?)$$" to="\1"/>
    </chainedmapper>
  </pathconvert>
  <property name="dita.topic.filename.root" value="${dita.map.filename.root}"/>
  
  <target name="dita2pdf5.ml.init" xmlns:if="ant:if" xmlns:unless="ant:unless">
    <property name="src.version" value="${otversion}"/>
    <property name="dst.version" value="4.0.0"/>
    <property name="operator" value="lt"/>
    <property name="delim" value="."/>
    <property name="result" value="ot.version.less.than.4"/>
    <version.comp src="${src.version}" 
      dst="${dst.version}"
      operator="${operator}"
      delim="${delim}" 
      result="${result}"/>
    
    <condition property="build-step.copy-image" value="false" unless:true="${ot.version.less.than.4}">
      <isfalse value="${copy.image.to.output.folder}"/>
    </condition>
    <condition property="build-step.copy-html" value="false" unless:true="${ot.version.less.than.4}">
      <isfalse value="${copy.image.to.output.folder}"/>
    </condition>
    <condition property="preprocess.copy-image.skip" value="true" if:true="${ot.version.less.than.4}">
      <isfalse value="${copy.image.to.output.folder}"/>
    </condition>
    <condition property="preprocess.copy-html.skip" value="true" if:true="${ot.version.less.than.4}">
      <isfalse value="${copy.image.to.output.folder}"/>
    </condition>
    <property name="build-step.chunk" value="false" unless:true="${ot.version.less.than.4}"/>
    <property name="preprocess.chunk.skip" value="true" if:true="${ot.version.less.than.4}"/>
    
    <property name="clean-preprocess.use-result-filename" value="false"/>
  
  </target>
  
  <target name="dita2pdf5.ml" depends="dita2pdf5.ml.init, build-init, dita2pdf5.ml.preprocess, map2pdf5.ml, topic2pdf5.ml"/> 
  
  <target name="dita2pdf5.ml.preprocess">
    <antcall target="dita2pdf5.ml.preprocess2.impl"/>
    <antcall target="dita2pdf5.ml.preprocess.impl"/>
  </target>
  
  <target name="dita2pdf5.ml.preprocess2.impl" xmlns:if="ant:if" xmlns:unless="ant:unless" if:true="${adopt.preprocess2}">
    <antcall target="preprocess2"/>
  </target>
  
  <target name="dita2pdf5.ml.preprocess.impl" xmlns:if="ant:if" xmlns:unless="ant:unless" unless:true="${adopt.preprocess2}">
    <antcall target="preprocess"/>
  </target>
  
  <target name="topic2pdf5.ml" if="noMap" depends="dita2pdf5.ml.preprocess">
    <!-- Generate merged middle file from topic -->
    <echo message="[pdf5.ml] Start generating merged middle file from topic."/>
    <makeurl file="${dita.temp.dir}${file.separator}${user.input.file}" property="topic.url" validate="yes"/>
    <xslt processor="trax" 
      in="${dita.dir}${file.separator}${pdf5.ml.dir}${file.separator}${pdf5.ml.plugin.folder}${file.separator}config${file.separator}topic-only-prototype.xml" 
      out="${dita.temp.dir}${file.separator}${dita.topic.filename.root}_MERGED.xml"
      style="${dita.dir}${file.separator}${pdf5.ml.dir}${file.separator}${pdf5.ml.plugin.folder}${file.separator}xsl${file.separator}dita2fo_gen_merged_shell.xsl" 
      force="true">
      <factory name="net.sf.saxon.TransformerFactoryImpl">
        <attribute name="http://saxon.sf.net/feature/timing" value="true"/>
        <!-- Suppress namespace warning -->
        <!--attribute name="http://saxon.sf.net/feature/suppressXsltNamespaceCheck" value="true"/-->
        <!--Assert-->
        <!--attribute name="http://saxon.sf.net/feature/enableAssertions" value="true"/-->
        <!-- Trace -->
        <!--attribute name="http://saxon.sf.net/feature/traceListenerClass" value="net.sf.saxon.trace.XSLTTraceListener"/-->
      </factory>
      <param name="PRM_TOPIC_FILE_URL" expression="${topic.url}"/>
    </xslt>
    
    <!-- Merged middle file to PDF -->
    <ant dir="${dita.dir}${file.separator}${pdf5.ml.dir}${file.separator}${pdf5.ml.plugin.folder}" target="merged2pdf">
      <property name="caller.basedir" value="${basedir}"/>
      <property name="build.map" value="no"/>
    </ant>
  </target>

  <target name="map2pdf5.ml" unless="noMap" depends="dita2pdf5.ml.preprocess">
    <!-- Call Java TopicMerge -->
    <echo message="[pdf5.ml] Start generating merged middle file."/>
  	<dirname property="dita.temp.dir.fullpath" file="${dita.temp.dir}${file.separator}dummy.file"/>
    <pipeline message="topicmerge" 
              inputmap="${dita.temp.dir.fullpath}${file.separator}${user.input.file}"
              tempdir="${dita.temp.dir.fullpath}">
		<module class="org.dita.dost.module.TopicMergeModule">
			<param name="output" location="${dita.temp.dir.fullpath}${file.separator}${dita.map.filename.root}_MERGED.xml"></param>
		</module>
    </pipeline>
    
    <!-- Merged middle file to PDF -->
    <ant dir="${dita.dir}${file.separator}${pdf5.ml.dir}${file.separator}${pdf5.ml.plugin.folder}" target="merged2pdf">
        <property name="caller.basedir" value="${basedir}"/>
      <property name="build.map" value="yes"/>
    </ant>
  </target>
</project>
